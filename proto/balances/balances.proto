syntax = "proto3";

package balances;

import "common/errors.proto";
import "common/numbers.proto";
import "common/statuses.proto";
import "common/timeseries.proto";
import "google/protobuf/timestamp.proto";
import "prices/prices.proto";
import "recipients/recipients.proto";
import "uoms/uoms.proto";

enum Type {
  TYPE_UNSPECIFIED = 0;
  TYPE_ACTUAL = 1;
  TYPE_UNREALIZED = 2;
}

message TypeList {
  repeated Type list = 1;
}

// Backed by table 'balances' + 'balance_alt'
message Balance {
  string id = 1; // System Key: id is generated by the server or the database
  Type type = 2;
  recipients.Recipient recipient = 3;
  google.protobuf.Timestamp timestamp = 4;
  string transaction_id = 5;
  uint32 item_no = 6;
  common.Decimal amount = 7;
  uoms.UoM currency = 8;
  optional Conversion legal_currency1 = 9;
  optional Conversion legal_currency2 = 10;
  optional Conversion legal_currency3 = 11;
  optional AltConversionList alt_conversions = 12;
  optional common.Status status = 13; // Default: 1
}

message List {
  repeated Balance list = 1;
}

message SelectList {
  repeated string list = 1;
}

message Conversion {
  optional common.Decimal amount = 1;
  optional uoms.UoM currency = 2;
  optional common.Decimal rate = 3;
  optional prices.Price price = 4;
}

message SelectConversion {
  optional common.DecimalValueList amount = 1;
  optional uoms.GetListRequest currency = 2;
  optional common.DecimalValueList rate = 3;
  optional prices.GetListRequest price = 4;
}

message AltConversion {
  uint32 alt = 1;
  common.Decimal amount = 2;
  uoms.UoM currency = 3;
  common.Decimal rate = 4;
  prices.Price price = 5;
  common.Status status = 6;
}

message AltConversionList {
  repeated AltConversion list = 1;
}

message RevaluateRequest {
  // id is generated by the server or the database
  recipients.Select recipient = 1;
}

message RevaluateResponse {
  oneof response {
    common.Error error = 1;
    Balance balance = 2;
  }
}

// Time Series

message TimeValue {
  google.protobuf.Timestamp timestamp = 1;
  common.Decimal amount = 2;
  uoms.UoM currency = 3;
  optional Conversion legal_currency1 = 4;
  optional Conversion legal_currency2 = 5;
  optional Conversion legal_currency3 = 6;
  optional AltConversionList alt_conversions = 7;
}

message TimeSeries {
  repeated TimeValue list = 1;
}

message GetTimeSeriesRequest {
  Type type = 1;
  recipients.SelectList recipients = 2;
  optional common.Timescale timescale = 3; // Default: UNSPECIFIED
  common.TimestampValueList timestamp = 4;
}

message GetTimeSeriesResponse {
  Type type = 1;
  recipients.List recipients = 2;
  optional common.Timescale timescale = 3; // Only when UNSPECIFIED
  TimeSeries values = 4;
}
